# 🏗️ 카카오봇 시스템 구조 설명

## 📁 핵심 파일 역할

### 1. main_improved.py (메인 서버)
- **역할**: FastAPI 서버 운영
- **기능**: 
  - HTTP 요청 수신
  - 타임아웃 처리 (4초)
  - 응답 캐시 (5초)
  - 메시지 정리 (1000자 제한, 이모지 변환)

### 2. command_manager.py (명령어 관리)
- **역할**: 명령어 정보 중앙 관리
- **기능**:
  - 명령어 목록 관리 (31개)
  - 명령어 설명 및 사용법
  - 권한 체크 (관리자/일반)
  - 도움말 생성
  - 핸들러 매핑 정보

### 3. fn.py (명령어 처리 로직) ⚠️ 삭제 불가!
- **역할**: 실제 명령어 처리 구현
- **기능**:
  - 각 명령어의 실제 동작 코드
  - API 호출 및 데이터 처리
  - 웹 크롤링 및 파싱
  - AI 응답 생성
  - 메시지 포맷팅

### 4. config.py (설정 관리)
- **역할**: 봇 설정 중앙 관리
- **기능**:
  - 허용된 방 목록
  - 관리자 목록
  - API 키 관리
  - 봇 정보

## 🔄 작동 흐름

```
1. 카카오톡 메시지 수신
   ↓
2. main_improved.py (FastAPI 서버)
   - 요청 수신
   - command_manager로 권한 체크
   ↓
3. command_manager.py
   - 명령어 확인
   - 권한 체크
   - 핸들러 이름 반환
   ↓
4. fn.py의 get_reply_msg()
   - 실제 명령어 처리
   - 각 함수 호출 (stock(), weather(), movie_rank() 등)
   ↓
5. 응답 반환
```

## ❓ 왜 fn.py를 삭제하면 안 되나요?

### fn.py의 주요 함수들:
```python
# AI 응답
def get_ai_answer(room, sender, msg)

# 주식 정보
def stock(room, sender, msg)

# 날씨 정보
def whether(room, sender, msg)

# 영화 순위
def movie_rank(room, sender, msg)

# 로또 번호
def lotto(room, sender, msg)

# 환율 정보
def exchange(room, sender, msg)

# ... 등 31개 명령어 처리 함수
```

이 함수들이 실제로:
- 네이버 API 호출
- 웹 페이지 크롤링
- 데이터 파싱 및 포맷팅
- 응답 메시지 생성

을 담당합니다.

## 📊 파일별 코드 라인 수

| 파일 | 라인 수 | 역할 |
|------|---------|------|
| fn.py | 3,200+ | 실제 처리 로직 |
| command_manager.py | 537 | 명령어 정보 관리 |
| main_improved.py | 200+ | 서버 운영 |
| config.py | 100+ | 설정 관리 |

## ✅ 현재 구조의 장점

1. **역할 분리**: 각 파일이 명확한 역할을 담당
2. **유지보수성**: 명령어 정보와 처리 로직이 분리되어 관리 용이
3. **확장성**: 새 명령어 추가 시 command_manager와 fn.py에 각각 추가
4. **안정성**: 핵심 로직이 분산되어 있어 하나의 파일 문제가 전체 시스템에 영향 최소화

## 🚫 삭제하면 안 되는 파일들

1. **fn.py** - 모든 명령어 처리 로직
2. **command_manager.py** - 명령어 정보 관리
3. **main_improved.py** - 서버 운영
4. **config.py** - 설정 관리
5. **naver.py** - 네이버 API 관련
6. **stock_improved.py** - 주식 정보 처리

## 💡 권장사항

- fn.py는 **절대 삭제하지 마세요**
- 명령어 추가 시:
  1. command_manager.py의 ALL_COMMANDS에 정보 추가
  2. fn.py에 실제 처리 함수 구현
- 명령어 삭제 시:
  1. command_manager.py에서 해당 명령어 제거
  2. fn.py의 함수는 남겨두어도 무방 (호출되지 않음)

---

*fn.py는 봇의 두뇌입니다. 삭제하면 봇이 작동하지 않습니다!*