# 메신저 봇 설정 가이드 - 간헐적 오류 해결

## 문제 현상
- 어떤 명령어는 바로 응답이 오고, 어떤 것은 응답이 안 옴
- 특히 영화 순위 같은 복잡한 명령어에서 자주 발생

## 원인 분석

### 1. **타임아웃 문제 (가장 흔함)**
```
[일반 명령어] 0.1초 → ✅ 성공
[영화 순위] 3-5초 → ❌ 타임아웃
```

### 2. **메시지 크기/특수문자 문제**
- 이모지가 많은 메시지 (🥇🥈🥉 등)
- 1000자 이상의 긴 메시지
- 특수 유니코드 문자

### 3. **중복 요청 문제**
- 메신저 봇이 응답을 못 받으면 자동 재시도
- 서버에 부하 증가 → 더 느려짐

## 해결 방법

### 방법 1: 메신저 봇 타임아웃 설정 변경

메신저 봇 스크립트에서:

```javascript
// 기존 코드
var result = Api.callApi({
    url: "https://YOUR_URL.ngrok.io/api/kakaotalk",
    method: "POST",
    data: { room: room, sender: sender, msg: msg }
});

// 개선된 코드 (타임아웃 10초)
var result = Api.callApi({
    url: "https://YOUR_URL.ngrok.io/api/kakaotalk",
    method: "POST",
    data: { room: room, sender: sender, msg: msg },
    timeout: 10000  // 10초 타임아웃
});
```

### 방법 2: 개선된 서버 사용

```bash
# 기존 서버 종료
Ctrl + C

# 개선된 서버 실행
python main_improved.py
```

개선 사항:
- 4초 타임아웃 자동 처리
- 응답 캐시 (중복 요청 방지)
- 메시지 자동 정리 (1000자 제한, 이모지 변환)

### 방법 3: 빠른 영화 순위 사용

fn.py를 수정:

```python
# fn.py 상단에 추가
from fn_optimized import movie_rank_fast

# movie_rank 함수를 대체
def movie_rank(room: str, sender: str, msg: str):
    """빠른 영화 순위"""
    return movie_rank_fast(room, sender, msg)
```

### 방법 4: 메신저 봇 응답 처리 개선

```javascript
function response(room, msg, sender, isGroupChat, replier) {
    try {
        // 영화 순위는 즉시 알림
        if (msg.includes("/영화순위")) {
            replier.reply("🎬 영화 순위 조회 중...");
        }
        
        // API 호출 (재시도 로직 포함)
        var result = null;
        var retryCount = 0;
        
        while (retryCount < 2 && !result) {
            result = Api.callApi({
                url: "https://YOUR_URL.ngrok.io/api/kakaotalk",
                method: "POST",
                data: { 
                    room: room, 
                    sender: sender, 
                    msg: msg 
                },
                timeout: 8000  // 8초
            });
            
            if (!result || !result.is_reply) {
                retryCount++;
                java.lang.Thread.sleep(1000);  // 1초 대기
            }
        }
        
        // 응답 처리
        if (result && result.is_reply) {
            // 긴 메시지 분할 전송
            var replyMsg = result.reply_msg;
            if (replyMsg.length > 500) {
                var parts = replyMsg.match(/.{1,500}/g);
                for (var i = 0; i < parts.length; i++) {
                    replier.reply(parts[i]);
                    if (i < parts.length - 1) {
                        java.lang.Thread.sleep(500);
                    }
                }
            } else {
                replier.reply(replyMsg);
            }
        }
    } catch(e) {
        // 오류 무시 (조용히 실패)
    }
}
```

## 즉시 적용 가능한 해결책

### 1단계: 서버 재시작
```bash
# 개선된 서버로 교체
python main_improved.py
```

### 2단계: 메신저 봇 타임아웃 늘리기
- 메신저 봇 앱에서 스크립트 수정
- timeout: 10000 추가

### 3단계: 테스트
```
/명령어  → 빠른 응답 확인
/영화순위 → 느린 응답도 오는지 확인
```

## 디버깅 명령어

서버 콘솔에서 확인할 내용:

```
[영화순위] 네이버 영화 시도...  # 빠른 방법
[영화순위] 네이버 성공         # 1초 이내
[영화순위] 캐시 사용 (5.2분 경과)  # 캐시 활용

또는

[영화순위] Selenium 시도 중...  # 느린 방법  
[영화순위] Selenium 성공       # 3-5초
타임아웃: /영화순위            # 4초 초과시
```

## 영구 해결 방법

### 옵션 1: 정적 스크래핑만 사용
- 빠르지만 데이터가 제한적
- fn_optimized.py 사용

### 옵션 2: 백그라운드 업데이트
- 30분마다 자동으로 영화 순위 업데이트
- 사용자 요청시 캐시된 데이터 즉시 전송

### 옵션 3: 비동기 응답
- "조회 중..." 메시지 먼저 전송
- 데이터 준비되면 추가 전송

## 체크리스트

✅ 메신저 봇 타임아웃 10초로 설정
✅ 서버 개선 버전 사용 (main_improved.py)
✅ 네이버/CGV 백업 스크래핑 활성화
✅ 응답 캐시 시스템 작동
✅ 메시지 1000자 제한
✅ 이모지 자동 변환

## 문제 지속시

1. ngrok 로그 확인: http://127.0.0.1:4040
2. 서버 로그에서 "타임아웃" 검색
3. 메신저 봇 로그 확인
4. 네트워크 상태 점검